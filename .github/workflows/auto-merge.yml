name: Auto-merge (label: auto-merge â†’ lab)

on:
  pull_request_target:
    types: [labeled, reopened, synchronize, ready_for_review]
  workflow_run:
    workflows: ["Smoke (Acceptance)"]
    types: [completed]

permissions:
  contents: write           # needed to (auto)merge
  pull-requests: write      # needed to enable auto-merge
  checks: read
  issues: write

concurrency:
  group: automerge-${{ github.event_name }}-${{ github.run_id }}
  cancel-in-progress: false

jobs:
  # --- Path 1: react immediately when a PR gets the label or is updated ---
  pr_event:
    if: ${{ github.event_name == 'pull_request_target' }}
    runs-on: ubuntu-latest
    steps:
      - name: Confirm repo allows auto-merge (fail with advice if off)
        uses: actions/github-script@v7
        id: setting
        with:
          script: |
            const { data: repo } = await github.rest.repos.get({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            if (!repo.allow_auto_merge) {
              core.setFailed('Repo setting "Allow auto-merge" is OFF. Enable it in Settings â†’ General â†’ Pull Requests to use bot auto-merge.');
            }

      - name: Check freeze status
        uses: actions/checkout@v4
        with:
          ref: lab
          sparse-checkout: |
            .ops/lab-freeze.json

      - name: Gate: base=lab & label=auto-merge & not frozen
        uses: actions/github-script@v7
        id: gate
        with:
          script: |
            const pr = context.payload.pull_request;
            const hasLabel = pr.labels.some(l => l.name === 'auto-merge');
            const baseOk  = pr.base.ref === 'lab';
            
            // Check freeze status
            let frozen = false;
            const fs = require('fs');
            if (fs.existsSync('.ops/lab-freeze.json')) {
              const freeze = JSON.parse(fs.readFileSync('.ops/lab-freeze.json', 'utf8'));
              frozen = freeze.frozen;
              if (frozen) {
                core.warning(`Lab is frozen: ${freeze.reason}`);
              }
            }
            
            core.setOutput('go', (hasLabel && baseOk && !frozen) ? 'true' : 'false');
            core.setOutput('number', pr.number.toString());
            core.setOutput('frozen', frozen ? 'true' : 'false');

      - name: Enable auto-merge
        if: steps.gate.outputs.go == 'true'
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          pull-request-number: ${{ steps.gate.outputs.number }}
          merge-method: squash

      - name: Comment result
        if: steps.gate.outputs.go == 'true' || steps.gate.outputs.frozen == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const number = Number('${{ steps.gate.outputs.number }}');
            const frozen = '${{ steps.gate.outputs.frozen }}' === 'true';
            const body = frozen
              ? "ðŸ”´ Auto-merge **blocked**: Lab is currently frozen. Remove the freeze to allow merges."
              : "ðŸ” Auto-merge **enabled** (label: `auto-merge`). GitHub will merge once all required checks are green, 1+ approval exists, and the branch is up-to-date.";
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: number,
              body: body
            });

  # --- Path 2: after Smoke finishes successfully, (re)attempt enabling auto-merge ---
  after_smoke:
    if: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Check freeze status
        uses: actions/checkout@v4
        with:
          ref: lab
          sparse-checkout: |
            .ops/lab-freeze.json

      - name: Abort if frozen
        id: freeze-check
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            if (fs.existsSync('.ops/lab-freeze.json')) {
              const freeze = JSON.parse(fs.readFileSync('.ops/lab-freeze.json', 'utf8'));
              if (freeze.frozen) {
                core.warning(`Skipping auto-merge: Lab is frozen (${freeze.reason})`);
                core.setOutput('skip', 'true');
                return;
              }
            }
            core.setOutput('skip', 'false');

      - name: Find candidate PRs for this SHA
        if: ${{ steps.freeze-check.outputs.skip != 'true' }}
        id: find
        uses: actions/github-script@v7
        with:
          script: |
            const sha = context.payload.workflow_run.head_sha;
            const { data: prs } = await github.request('GET /repos/{owner}/{repo}/commits/{commit_sha}/pulls', {
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: sha,
              headers: { 'X-GitHub-Api-Version': '2022-11-28' }
            });
            const candidates = prs.filter(pr =>
              pr.state === 'open' &&
              pr.base.ref === 'lab' &&
              (pr.labels || []).some(l => l.name === 'auto-merge')
            ).map(pr => pr.number);
            core.setOutput('numbers', JSON.stringify(candidates));

      - name: Enable auto-merge on each candidate
        if: ${{ steps.find.outputs.numbers != '[]' && steps.freeze-check.outputs.skip != 'true' }}
        uses: actions/github-script@v7
        with:
          script: |
            const numbers = JSON.parse(`${{ toJSON(steps.find.outputs.numbers) }}`);
            for (const n of numbers) {
              await exec.exec('bash', ['-lc', `gh pr merge --squash --auto "${n}"`], {
                env: { GH_TOKEN: process.env.GITHUB_TOKEN }
              });
            }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment summary
        if: ${{ steps.find.outputs.numbers != '[]' && steps.freeze-check.outputs.skip != 'true' }}
        uses: actions/github-script@v7
        with:
          script: |
            const numbers = JSON.parse(`${{ toJSON(steps.find.outputs.numbers) }}`);
            for (const n of numbers) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: n,
                body: "âœ… Smoke passed. Auto-merge has been enabled (or merge executed if all gates already satisfied)."
              });
            }